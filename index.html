<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fan - è·¨å¹³å°è½¯ä»¶å‰ç«¯åç¼–è¯‘æå–å·¥å…·</title>
    <!-- æ¶²æ€æ•ˆæœSVGæ»¤é•œ -->
    <svg width="0" height="0" style="position:absolute;">
      <defs>
        <!-- æ¶²æ€æ•ˆæœæ»¤é•œ -->
        <filter id="liquid-effect">
          <feTurbulence type="fractalNoise" baseFrequency="0.01" numOctaves="3" result="noise" seed="1"></feTurbulence>
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="5" xChannelSelector="R" yChannelSelector="G"></feDisplacementMap>
        </filter>
        <!-- æ¶²æ€æ³¢çº¹æ»¤é•œ -->
        <filter id="liquid-ripple">
          <feTurbulence type="turbulence" baseFrequency="0.05" numOctaves="2" result="noise"></feTurbulence>
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="10" xChannelSelector="R" yChannelSelector="G"></feDisplacementMap>
        </filter>
      </defs>
    </svg>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
        position: relative;
      }

      body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
          radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 40% 40%, rgba(100, 108, 255, 0.05) 0%, transparent 50%);
        animation: liquidBackground 15s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
      }

      @keyframes liquidBackground {
        0%, 100% {
          transform: translateX(0) translateY(0);
        }
        25% {
          transform: translateX(2%) translateY(2%);
        }
        50% {
          transform: translateX(0) translateY(4%);
        }
        75% {
          transform: translateX(-2%) translateY(2%);
        }
      }

      header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        text-align: center;
        color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      header h1 {
        font-size: 24px;
        font-weight: 600;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        position: relative;
        z-index: 1;
      }

      .drag-area {
        width: 800px;
        height: 400px;
        border: 3px dashed rgba(255, 255, 255, 0.5);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        z-index: 1;
        will-change: transform, box-shadow;
        transform: translateZ(0);
      }

      .drag-area::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent 0%,
          rgba(255, 255, 255, 0.05) 50%,
          transparent 100%
        );
        transform: rotate(45deg);
        animation: liquidDrag 6s linear infinite;
        pointer-events: none;
        z-index: -1;
      }

      .drag-area:hover {
        border-color: rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 30px rgba(100, 108, 255, 0.3);
      }

      .drag-area.drag-active {
        border-color: #4CAF50;
        background: rgba(76, 175, 80, 0.1);
        animation: liquidPulse 1s ease-in-out infinite;
      }

      @keyframes liquidDrag {
        0% {
          transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) translateY(100%) rotate(45deg);
        }
      }

      @keyframes liquidPulse {
        0%, 100% {
          box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }
        50% {
          box-shadow: 0 0 40px rgba(76, 175, 80, 0.5);
        }
      }

      .drag-area-icon {
        font-size: 80px;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 20px;
      }

      .drag-area-text {
        color: white;
        font-size: 18px;
        text-align: center;
        margin-bottom: 20px;
      }

      .drag-area-small-text {
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
      }

      .liquid-button {
        position: relative;
        border: none;
        border-radius: 12px;
        padding: 0.8em 1.5em;
        font-size: 1em;
        font-weight: 600;
        font-family: inherit;
        background: linear-gradient(135deg, rgba(100, 108, 255, 0.8), rgba(83, 91, 242, 0.9));
        color: white;
        cursor: pointer;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(100, 108, 255, 0.3);
        will-change: transform, box-shadow;
        transform: translateZ(0);
      }

      .liquid-button::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          to bottom right,
          rgba(255, 255, 255, 0.2) 0%,
          rgba(255, 255, 255, 0) 50%,
          rgba(255, 255, 255, 0.2) 100%
        );
        transform: rotate(45deg);
        animation: liquidFlow 3s linear infinite;
        pointer-events: none;
      }

      .liquid-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(100, 108, 255, 0.4);
        filter: brightness(1.05);
      }

      .liquid-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 15px rgba(100, 108, 255, 0.3);
        animation: liquidRipple 0.6s ease-out;
      }

      /* æ¶²æ€æµåŠ¨åŠ¨ç”» */
      @keyframes liquidFlow {
        0% {
          transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) translateY(100%) rotate(45deg);
        }
      }

      /* æ¶²æ€æ³¢çº¹åŠ¨ç”» */
      @keyframes liquidRipple {
        0%, 100% {
          filter: url(#liquid-ripple);
          transform: scale(1);
        }
        50% {
          filter: url(#liquid-ripple);
          transform: scale(1.05);
        }
      }

      .upload-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        padding: 12px 24px;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
      }

      .upload-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .progress-container {
        width: 800px;
        margin-top: 40px;
        display: none;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4CAF50, #45a049);
        border-radius: 10px;
        width: 0%;
        transition: width 0.3s ease;
      }

      .progress-text {
        color: white;
        font-size: 14px;
        text-align: center;
      }

      .result-container {
        width: 800px;
        margin-top: 40px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 30px;
        color: white;
        display: none;
      }

      .result-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
      }

      .result-info {
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .result-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
      }

      .result-btn {
        position: relative;
        border: none;
        border-radius: 12px;
        padding: 0.8em 1.5em;
        font-size: 1em;
        font-weight: 600;
        font-family: inherit;
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.8), rgba(69, 160, 73, 0.9));
        color: white;
        cursor: pointer;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
        will-change: transform, box-shadow;
        transform: translateZ(0);
      }

      .result-btn::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          to bottom right,
          rgba(255, 255, 255, 0.2) 0%,
          rgba(255, 255, 255, 0) 50%,
          rgba(255, 255, 255, 0.2) 100%
        );
        transform: rotate(45deg);
        animation: liquidFlow 3s linear infinite;
        pointer-events: none;
      }

      .result-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(76, 175, 80, 0.4);
        filter: brightness(1.05);
      }

      .result-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 15px rgba(76, 175, 80, 0.3);
        animation: liquidRipple 0.6s ease-out;
      }

      .error-message {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid rgba(244, 67, 54, 0.4);
        border-radius: 8px;
        padding: 15px;
        color: #ffcdd2;
        margin-top: 20px;
        display: none;
      }

      footer {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        text-align: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
      }

      /* æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŠ¨ç”»å¤æ‚åº¦ */
      @media (prefers-reduced-motion: reduce) {
        .liquid-button::before {
          animation: none;
        }
        .result-btn::before {
          animation: none;
        }
        .drag-area::before {
          animation: none;
        }
        body::before {
          animation: none;
        }
        .drag-area.drag-active {
          animation: none;
          box-shadow: 0 0 30px rgba(76, 175, 80, 0.4);
        }
      }

      /* ä½æ€§èƒ½è®¾å¤‡é™çº§ */
      @media (max-width: 768px) {
        .liquid-button::before {
          animation-duration: 6s; /* å‡æ…¢åŠ¨ç”»é€Ÿåº¦ */
        }
        .result-btn::before {
          animation-duration: 6s; /* å‡æ…¢åŠ¨ç”»é€Ÿåº¦ */
        }
        .drag-area::before {
          animation-duration: 10s; /* å‡æ…¢åŠ¨ç”»é€Ÿåº¦ */
        }
        body::before {
          animation-duration: 20s; /* å‡æ…¢åŠ¨ç”»é€Ÿåº¦ */
        }
      }

      @media (max-width: 900px) {
        .drag-area,
        .progress-container,
        .result-container {
          width: 100%;
          max-width: 600px;
        }

        .drag-area {
          height: 300px;
        }

        .drag-area-icon {
          font-size: 60px;
        }

        .drag-area-text {
          font-size: 16px;
        }
        
        /* å“åº”å¼è°ƒæ•´æŒ‰é’®å¤§å° */
        .liquid-button {
          padding: 0.6em 1.2em;
          font-size: 0.9em;
        }
        
        .result-btn {
          padding: 0.6em 1.2em;
          font-size: 0.9em;
        }
      }

      /* æå°å±å¹•è¿›ä¸€æ­¥ä¼˜åŒ– */
      @media (max-width: 480px) {
        .liquid-button {
          padding: 0.5em 1em;
          font-size: 0.8em;
        }
        
        .result-btn {
          padding: 0.5em 1em;
          font-size: 0.8em;
        }
        
        .drag-area {
          height: 250px;
        }
        
        .drag-area-icon {
          font-size: 50px;
        }
        
        .drag-area-text {
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Fan - è·¨å¹³å°è½¯ä»¶å‰ç«¯åç¼–è¯‘æå–å·¥å…·</h1>
    </header>

    <main>
      <div class="drag-area" id="dragArea">
        <div class="drag-area-icon">ğŸ“¦</div>
        <div class="drag-area-text">æ‹–æ‹½è½¯ä»¶åŒ…åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»ä¸Šä¼ </div>
        <div class="drag-area-small-text">æ”¯æŒ Electron å®‰è£…åŒ…ã€å‹ç¼©åŒ…ã€å‰ç«¯ç¼–è¯‘åŒ…ç­‰æ ¼å¼</div>
      </div>
      <div style="margin-top: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <button class="liquid-button" id="uploadBtn">é€‰æ‹©æ–‡ä»¶</button>
        <button class="liquid-button" id="outputPathBtn">é€‰æ‹©è¾“å‡ºè·¯å¾„</button>
        <button class="liquid-button" id="checkPermissionBtn">æ£€æŸ¥æƒé™</button>
        <span id="currentOutputPath" style="color: white; font-size: 14px; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">é»˜è®¤è·¯å¾„: ä¸‹è½½æ–‡ä»¶å¤¹/fan-output</span>
      </div>

      <div class="permission-manager" id="permissionManager" style="margin-top: 20px; width: 800px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; color: white; display: none;">
        <h3 style="margin-bottom: 15px; text-align: center;">æƒé™ç®¡ç†å·¥å…·</h3>
        
        <div class="permission-section" style="margin-bottom: 20px;">
          <h4 style="margin-bottom: 10px;">è·¯å¾„æƒé™æ£€æµ‹</h4>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="permissionPathInput" placeholder="è¾“å…¥è·¯å¾„æˆ–ä½¿ç”¨é»˜è®¤è·¯å¾„" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: white;">
            <button class="liquid-button" id="detectPermissionBtn" style="padding: 10px 20px;">æ£€æµ‹æƒé™</button>
            <button class="liquid-button" id="useRecommendedPathBtn" style="padding: 10px 20px;">ä½¿ç”¨æ¨èè·¯å¾„</button>
          </div>
        </div>

        <div class="permission-result" id="permissionResult" style="margin-bottom: 20px; padding: 15px; border-radius: 10px; background: rgba(255, 255, 255, 0.05); display: none;">
          <h4 style="margin-bottom: 10px;">æ£€æµ‹ç»“æœ</h4>
          <div id="permissionResultContent"></div>
        </div>

        <div class="permission-solution" id="permissionSolution" style="margin-bottom: 20px; padding: 15px; border-radius: 10px; background: rgba(255, 255, 255, 0.05); display: none;">
          <h4 style="margin-bottom: 10px;">è§£å†³æ–¹æ¡ˆ</h4>
          <div id="permissionSolutionContent"></div>
        </div>

        <div class="disk-status" id="diskStatus" style="margin-bottom: 20px; padding: 15px; border-radius: 10px; background: rgba(255, 255, 255, 0.05); display: none;">
          <h4 style="margin-bottom: 10px;">ç£ç›˜çŠ¶æ€</h4>
          <div id="diskStatusContent"></div>
        </div>

        <div class="permission-actions" style="display: flex; justify-content: center; gap: 20px;">
          <button class="liquid-button" id="applyPermissionBtn" style="padding: 12px 24px;">åº”ç”¨ä¿®å¤</button>
          <button class="liquid-button" id="closePermissionBtn" style="padding: 12px 24px;">å…³é—­</button>
        </div>
      </div>

      <div class="error-message" id="errorMessage"></div>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
      </div>

      <div class="result-container" id="resultContainer">
        <div class="result-title">è§£æå®Œæˆ</div>
        <div class="result-info" id="resultInfo">
          <p>å‰ç«¯èµ„æºå·²æˆåŠŸæå–å¹¶è¿˜åŸ</p>
          <p>è¾“å‡ºè·¯å¾„ï¼š<span id="outputPath"></span></p>
        </div>
        <div class="result-buttons">
          <button class="result-btn" id="openOutputBtn">æ‰“å¼€è¾“å‡ºç›®å½•</button>
          <button class="result-btn" id="newTaskBtn">å¼€å§‹æ–°ä»»åŠ¡</button>
        </div>
      </div>
    </main>

    <footer>
      <p>ä»…ç”¨äºåˆæ³•åˆè§„çš„å‰ç«¯èµ„æºæå–ï¼Œç¦æ­¢ç”¨äºä¾µæƒã€ç ´è§£ç­‰éæ³•è¡Œä¸º</p>
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const dragArea = document.getElementById('dragArea');
        const uploadBtn = document.getElementById('uploadBtn');
        const outputPathBtn = document.getElementById('outputPathBtn');
        const currentOutputPathEl = document.getElementById('currentOutputPath');
        const errorMessage = document.getElementById('errorMessage');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultContainer = document.getElementById('resultContainer');
        const resultInfo = document.getElementById('resultInfo');
        const outputPath = document.getElementById('outputPath');
        const openOutputBtn = document.getElementById('openOutputBtn');
        const newTaskBtn = document.getElementById('newTaskBtn');
        
        // å­˜å‚¨ç”¨æˆ·é€‰æ‹©çš„è¾“å‡ºè·¯å¾„
        let customOutputPath = null;
        
        // æƒé™ç®¡ç†å·¥å…·ç›¸å…³å…ƒç´ 
        const permissionManagerEl = document.getElementById('permissionManager');
        const checkPermissionBtn = document.getElementById('checkPermissionBtn');
        const closePermissionBtn = document.getElementById('closePermissionBtn');
        const permissionPathInput = document.getElementById('permissionPathInput');
        const detectPermissionBtn = document.getElementById('detectPermissionBtn');
        const useRecommendedPathBtn = document.getElementById('useRecommendedPathBtn');
        const applyPermissionBtn = document.getElementById('applyPermissionBtn');
        const permissionResultEl = document.getElementById('permissionResult');
        const permissionResultContent = document.getElementById('permissionResultContent');
        const permissionSolutionEl = document.getElementById('permissionSolution');
        const permissionSolutionContent = document.getElementById('permissionSolutionContent');
        const diskStatusEl = document.getElementById('diskStatus');
        const diskStatusContent = document.getElementById('diskStatusContent');

        // æ‹–æ‹½åŠŸèƒ½
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dragArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
          dragArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          dragArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
          dragArea.classList.add('drag-active');
        }

        function unhighlight() {
          dragArea.classList.remove('drag-active');
        }

        dragArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          if (files.length > 0) {
            processFile(files[0].path);
          }
        }

        // ä¸Šä¼ æŒ‰é’®
        uploadBtn.addEventListener('click', async function() {
          const filePath = await window.electronAPI.selectFile();
          if (filePath) {
            processFile(filePath);
          }
        });
        
        // è¾“å‡ºè·¯å¾„é€‰æ‹©æŒ‰é’®
        outputPathBtn.addEventListener('click', async function() {
          const selectedPath = await window.electronAPI.selectFolder();
          if (selectedPath) {
            customOutputPath = selectedPath;
            currentOutputPathEl.textContent = `è‡ªå®šä¹‰è·¯å¾„: ${selectedPath}`;
          }
        });
        
        // æ‰“å¼€æƒé™ç®¡ç†å·¥å…·
        checkPermissionBtn.addEventListener('click', function() {
          permissionManagerEl.style.display = 'block';
          // è‡ªåŠ¨å¡«å……å½“å‰è¾“å‡ºè·¯å¾„
          permissionPathInput.value = customOutputPath || 'é»˜è®¤è·¯å¾„: ä¸‹è½½æ–‡ä»¶å¤¹/fan-output';
        });
        
        // å…³é—­æƒé™ç®¡ç†å·¥å…·
        closePermissionBtn.addEventListener('click', function() {
          permissionManagerEl.style.display = 'none';
        });
        
        // ä½¿ç”¨æ¨èè·¯å¾„
        useRecommendedPathBtn.addEventListener('click', async function() {
          try {
            const result = await window.electronAPI.getRecommendedPath();
            if (result.success) {
              permissionPathInput.value = result.path;
              customOutputPath = result.path;
              currentOutputPathEl.textContent = `è‡ªå®šä¹‰è·¯å¾„: ${result.path}`;
            }
          } catch (error) {
            errorMessage.textContent = `é”™è¯¯ï¼š${error.message}`;
            errorMessage.style.display = 'block';
          }
        });
        
        // æ£€æµ‹æƒé™
        detectPermissionBtn.addEventListener('click', async function() {
          try {
            const targetPath = permissionPathInput.value.trim();
            if (!targetPath || targetPath.startsWith('é»˜è®¤è·¯å¾„:')) {
              // ä½¿ç”¨æ¨èè·¯å¾„
              const recommendedResult = await window.electronAPI.getRecommendedPath();
              if (recommendedResult.success) {
                permissionPathInput.value = recommendedResult.path;
                checkPermissions(recommendedResult.path);
              }
            } else {
              checkPermissions(targetPath);
            }
          } catch (error) {
            errorMessage.textContent = `é”™è¯¯ï¼š${error.message}`;
            errorMessage.style.display = 'block';
          }
        });
        
        // åº”ç”¨æƒé™ä¿®å¤
        applyPermissionBtn.addEventListener('click', async function() {
          try {
            const targetPath = permissionPathInput.value.trim();
            if (!targetPath || targetPath.startsWith('é»˜è®¤è·¯å¾„:')) {
              // ä½¿ç”¨æ¨èè·¯å¾„
              const recommendedResult = await window.electronAPI.getRecommendedPath();
              if (recommendedResult.success) {
                applyPermissionFix(recommendedResult.path);
              }
            } else {
              applyPermissionFix(targetPath);
            }
          } catch (error) {
            errorMessage.textContent = `é”™è¯¯ï¼š${error.message}`;
            errorMessage.style.display = 'block';
          }
        });
        
        // æ£€æŸ¥æƒé™å‡½æ•°
        async function checkPermissions(targetPath) {
          try {
            errorMessage.style.display = 'none';
            
            // æ£€æµ‹æƒé™
            const permissionResult = await window.electronAPI.detectPermissions(targetPath);
            
            // æ˜¾ç¤ºæƒé™æ£€æµ‹ç»“æœ
            showPermissionResult(permissionResult);
            
            // æ£€æµ‹ç£ç›˜çŠ¶æ€
            const diskStatus = await window.electronAPI.detectDiskStatus(targetPath);
            showDiskStatus(diskStatus);
            
          } catch (error) {
            errorMessage.textContent = `é”™è¯¯ï¼š${error.message}`;
            errorMessage.style.display = 'block';
          }
        }
        
        // åº”ç”¨æƒé™ä¿®å¤å‡½æ•°
        async function applyPermissionFix(targetPath) {
          try {
            errorMessage.style.display = 'none';
            
            // éªŒè¯å¹¶åˆ›å»ºè·¯å¾„
            const validationResult = await window.electronAPI.validateAndCreatePath(targetPath);
            
            if (validationResult.success) {
              errorMessage.textContent = `æˆåŠŸï¼šè·¯å¾„éªŒè¯å’Œåˆ›å»ºæˆåŠŸ`;
              errorMessage.style.background = 'rgba(76, 175, 80, 0.2)';
              errorMessage.style.border = '1px solid rgba(76, 175, 80, 0.4)';
              errorMessage.style.color = '#c8e6c9';
              errorMessage.style.display = 'block';
              
              // æ›´æ–°å½“å‰è¾“å‡ºè·¯å¾„
              customOutputPath = targetPath;
              currentOutputPathEl.textContent = `è‡ªå®šä¹‰è·¯å¾„: ${targetPath}`;
              
              // é‡æ–°æ£€æµ‹æƒé™
              checkPermissions(targetPath);
            } else {
              errorMessage.textContent = `é”™è¯¯ï¼š${validationResult.error}`;
              errorMessage.style.display = 'block';
            }
            
          } catch (error) {
            errorMessage.textContent = `é”™è¯¯ï¼š${error.message}`;
            errorMessage.style.display = 'block';
          }
        }
        
        // æ˜¾ç¤ºæƒé™æ£€æµ‹ç»“æœ
        function showPermissionResult(result) {
          permissionResultEl.style.display = 'block';
          
          if (result.success) {
            let content = `<p><strong>è·¯å¾„:</strong> ${result.path}</p>`;
            content += `<p><strong>å­˜åœ¨:</strong> ${result.exists ? 'æ˜¯' : 'å¦'}</p>`;
            content += `<p><strong>ç±»å‹:</strong> ${result.isDirectory ? 'ç›®å½•' : 'æ–‡ä»¶'}</p>`;
            content += `<p><strong>æƒé™:</strong></p>`;
            content += `<ul>`;
            content += `<li>è¯»å–: ${result.permissions.read ? 'âœ“' : 'âœ—'}</li>`;
            content += `<li>å†™å…¥: ${result.permissions.write ? 'âœ“' : 'âœ—'}</li>`;
            content += `<li>æ‰§è¡Œ: ${result.permissions.execute ? 'âœ“' : 'âœ—'}</li>`;
            content += `</ul>`;
            content += `<p><strong>å¹³å°:</strong> ${result.platform}</p>`;
            
            permissionResultContent.innerHTML = content;
            
            // æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
            const solution = result.solution || {
              type: 'permission_granted',
              message: 'æƒé™æ­£å¸¸',
              steps: [],
              recommendedAction: 'proceed'
            };
            showPermissionSolution(solution);
          } else {
            permissionResultContent.innerHTML = `<p><strong>é”™è¯¯:</strong> ${result.error}</p>`;
            showPermissionSolution({
              type: 'unknown_error',
              message: `æƒé™æ£€æµ‹å¤±è´¥ï¼š${result.error}`,
              steps: [
                'æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®',
                'ç¡®ä¿è·¯å¾„å­˜åœ¨',
                'å°è¯•é€‰æ‹©å…¶ä»–è·¯å¾„'
              ],
              recommendedAction: 'select_other_path'
            });
          }
        }
        
        // æ˜¾ç¤ºæƒé™è§£å†³æ–¹æ¡ˆ
        function showPermissionSolution(solution) {
          permissionSolutionEl.style.display = 'block';
          
          let content = `<p><strong>é—®é¢˜ç±»å‹:</strong> ${solution.type}</p>`;
          content += `<p><strong>è§£å†³æ–¹æ¡ˆ:</strong> ${solution.message}</p>`;
          
          if (solution.steps && solution.steps.length > 0) {
            content += `<p><strong>æ“ä½œæ­¥éª¤:</strong></p>`;
            content += `<ol>`;
            solution.steps.forEach(step => {
              content += `<li>${step}</li>`;
            });
            content += `</ol>`;
          }
          
          content += `<p><strong>æ¨èæ“ä½œ:</strong> ${solution.recommendedAction}</p>`;
          
          permissionSolutionContent.innerHTML = content;
        }
        
        // æ˜¾ç¤ºç£ç›˜çŠ¶æ€
        function showDiskStatus(result) {
          diskStatusEl.style.display = 'block';
          
          if (result.success) {
            const totalGB = (result.total / (1024 * 1024 * 1024)).toFixed(2);
            const freeGB = (result.free / (1024 * 1024 * 1024)).toFixed(2);
            const usedGB = (result.used / (1024 * 1024 * 1024)).toFixed(2);
            const usedPercentage = result.usedPercentage.toFixed(2);
            
            let content = `<p><strong>ç£ç›˜è·¯å¾„:</strong> ${result.path}</p>`;
            content += `<p><strong>æ€»ç©ºé—´:</strong> ${totalGB} GB</p>`;
            content += `<p><strong>å·²ç”¨ç©ºé—´:</strong> ${usedGB} GB (${usedPercentage}%)</p>`;
            content += `<p><strong>å¯ç”¨ç©ºé—´:</strong> ${freeGB} GB</p>`;
            content += `<p><strong>åªè¯»çŠ¶æ€:</strong> ${result.isReadOnly ? 'æ˜¯' : 'å¦'}</p>`;
            
            diskStatusContent.innerHTML = content;
          } else {
            diskStatusContent.innerHTML = `<p><strong>é”™è¯¯:</strong> ${result.error}</p>`;
          }
        }

        // å¤„ç†æ–‡ä»¶
        let currentOutputPath = '';

        // ç›‘å¬è¿›åº¦æ›´æ–°
        window.electronAPI.onProgress((progress) => {
          if (progress.progress !== undefined) {
            progressFill.style.width = progress.progress + '%';
          }
          if (progress.message) {
            progressText.textContent = progress.message;
          }
        });

        async function processFile(filePath) {
          try {
            errorMessage.style.display = 'none';
            progressContainer.style.display = 'block';
            resultContainer.style.display = 'none';

            progressFill.style.width = '0%';
            progressText.textContent = 'å¼€å§‹è§£ææ–‡ä»¶...';

            // è°ƒç”¨ä¸»è¿›ç¨‹è§£æï¼Œä¼ é€’è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„
            const result = await window.electronAPI.parseFile(filePath, customOutputPath);

            if (result.success) {
              progressFill.style.width = '100%';
              progressText.textContent = 'è§£æå®Œæˆ';
              
              currentOutputPath = result.outputPath;
              
              setTimeout(() => {
                progressContainer.style.display = 'none';
                resultContainer.style.display = 'block';
                outputPath.textContent = currentOutputPath;
              }, 500);
            } else {
              throw new Error(result.message);
            }
          } catch (error) {
            progressContainer.style.display = 'none';
            errorMessage.textContent = `é”™è¯¯ï¼š${error.message}`;
            errorMessage.style.display = 'block';
          }
        }

        // ç»“æœæŒ‰é’®
        openOutputBtn.addEventListener('click', async function() {
          if (currentOutputPath) {
            await window.electronAPI.openOutputDir(currentOutputPath);
          }
        });

        newTaskBtn.addEventListener('click', function() {
          resultContainer.style.display = 'none';
          errorMessage.style.display = 'none';
        });
      });
    </script>
  </body>
</html>
